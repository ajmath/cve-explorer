import React, {createContext, useContext, useReducer, Reducer, Dispatch} from 'react';
import { CveSearchInput } from './gql-gen';

interface AppState {
  searchInput: CveSearchInput;
  nextSearchInput: CveSearchInput | null;
  prevSearchInput: CveSearchInput | null;
}
const defaultState: AppState = {
  searchInput: {
    query: "",
    limit: 12,
  },
  nextSearchInput: null,
  prevSearchInput: null,
};

type AppReducer = Reducer<AppState, Actions>;
export const StateContext = createContext<[ AppState, Dispatch<Actions> ]>([
  defaultState,
  () => void 0,
]);

export enum ActionType {
  NEXT_PAGE,
  PREV_PAGE,
  UPDATE_STATE,
}
interface Action<T extends ActionType> {
  type: T;
}

interface NextPageAction extends Action<ActionType.NEXT_PAGE> {}
interface PrevPageAction extends Action<ActionType.PREV_PAGE> {}
interface UpdateStateAction extends Action<ActionType.UPDATE_STATE> {
  newState: Partial<AppState>;
}

type Actions = NextPageAction | PrevPageAction | UpdateStateAction;

const reducer: AppReducer = (state, action) => {
  switch (action.type) {
    case ActionType.NEXT_PAGE:
      if (!state.nextSearchInput) {
        break;
      }
      return {
        ...state,
        searchInput: {
          ...state.nextSearchInput,
          __typename: undefined,
        },
        nextPageSearchInput: null,
      };
    case ActionType.PREV_PAGE:
      if (!state.prevSearchInput) {
        break;
      }
      return {
        ...state,
        searchInput: {
          ...state.prevSearchInput,
          __typename: undefined,
        },
        prevPageSearchInput: null,
      };
    case ActionType.UPDATE_STATE:
      const updatedState = {
        ...state,
        ...action.newState,
      };
      if (JSON.stringify(state) === JSON.stringify(updatedState)) {
        return state;
      }
      return updatedState;
  }
  return state;
};


export const StateProvider: React.FC = ({children}) => (
  <StateContext.Provider value={useReducer<AppReducer>(reducer, defaultState)}>
    {children}
  </StateContext.Provider>
);

export const useStateValue = () => useContext(StateContext);
